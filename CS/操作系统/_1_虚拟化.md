<!--
 * @Author: 崩布猪
 * @Date: 2024-03-19 13:34:00
 * @LastEditors: 崩布猪
 * @LastEditTime: 2024-04-17 13:22:37
 * @FilePath: \操作系统\_1_虚拟化.md
 * @Description: 
 * 这个笔记时用来记录学习操作系统 当中的虚拟化篇 总共三大篇章 分别是 虚拟化、并发、持久性
 * 
 -->
# 虚拟化

操作系统通过虚拟化CPU 来提供多个虚拟的CPU，每个虚拟的CPU都有自己的地址空间，可以运行不同的进程。 基于时分共享技术。

时分共享CPU技术：一个进程只运行一个时间片，然后切换到其他进程
补充： 空间共享CPU技术：多个进程可以共享内存空间，每个进程有自己的地址空间，可以运行不同的进程。

许多任务共享物理CPU的基本思想：
运行一个进程一段时间，然后运行另一个进程，如此轮换通过这种时分共享CPU 实现的虚拟化
## 虚拟化CPU
实现CPU虚拟化需要:
- 机制（又称 低级机制 他是一些低级的方法或协议）
- 高级智能 操作系统中有一些智能一策略的形式存在
- 通过机制和智能的方式调度所需的高级策略

## 抽象：进程
定义：一个正在运行的程序就是一个进程。 
进程的机器状态
- 程序在运行的时可以读取或者更新的内容，在什么时刻，机器的哪一些部分对执行该程序很重要
- 组成 
  - 内存（明显） 进程可以访问的内存（地址空间）是该进程的一部分
  - 寄存器  
补充：分离策略和机制- 一个通用的设计范式，它将高级策略和低级机制分离开来

程序是怎么转化为进程的 
- 第一件事 将代码和所有静态数据加载到内存中
- 之后 并在运行 此进程之前 执行一些其他操作 
  - 给程序的运行时栈分配一些内存
  - 给程序的堆分配一些内存
  - i/o相关的任务
  - 其他
- 启动程序

进程/的三种基本状态 *
  -  就绪状态
     -  进程已经准备好 由于某种原因，操作系统选择不在此时运行
  -  运行状态
     -  进程正在处理器上运行。
  -  阻塞状态
     -  一个进程执行了某种操作，知道发生其他时间时才会准备运行。

### 数据结构
操作系统也是一个程序，它有一些关键的数据结构来跟踪各种相关信息
进程列表： 系统中所有进程的集合
进程控制块（PCB）： 包含了进程的相关信息，包括进程标识符、进程状态、进程优先级、进程的地址空间、进程的执行栈、进程的打开文件、进程的信号量、进程的消息队列等。

## 进程API
- 所有现代操作系统都会以某种形式提供这些API（接口）
  - 创建
  - 销毁
  - 等待
  - 其他控制
  - 状态
unix系统中进程API的创建方式：
- fork() 创建一个新的进程
- exec() 加载并运行一个新的程序
- wait() 等待子进程结束
- exit() 终止进程

## 受限直接执行
如何高效、可控地虚拟化 CPU ，--需要硬件和操作系统的支持 操作系统通常会明治地利用硬件支持，以便高效地实现其工作

基本的技巧：
受限直接执行
直接执行：在CPU上运行程序

受限制的操作
硬件通过提供不同的执行模式来协助操作系统
在用户模式下 应用程序不能完全访问硬件，只能访问受限的资源
在内核模式下 应用程序可以完全访问硬件。
还有陷阱（trap）机制，它允许操作系统在用户模式下运行时，访问受限的资源。
陷阱返回（trap return）：当陷阱返回时，应用程序可以继续运行。

在进程之间切换
协作方式，等待系统调用
协作方式，操作系统进行控制

## 进程调度
操作系统必须决定哪个进程应该运行，哪个进程应该被阻塞，哪个进程应该被唤醒。
调度指标
  周转时间： 完成时间 - 到达时间
  响应时间： 首次运行 - 到达时间

调度算法：
- 先进先出（FIFO）
- 短作业优先（SJF）
- 最短完成时间优先（STCF）
- 轮转法
- 多级反馈队列（MLFQ）
  - 如果A的优先级 > B的优先级，则A运行
  - 如果A的优先级 = B的优先级，则A和B轮流运行
  - 工作进入系统时，放在最高优先级
  - 一旦工作用完了它在某一层的时间配额就降低优先级
  - 经过一段时间S后，将系统所有工作重新加入最高优先级队列
- 比例份额（彩票调度）
  - 基本概念：彩票数表示份额（进程占有某个资源的份额）
- 多处理器调度

# 虚拟化内存  
虚拟化内存是指将物理内存抽象成多个虚拟内存，每个虚拟内存都有自己的地址空间。

## 进程同步
- 进程的同步概念
- 临界资源
- 临界区
- 同步机制应遵循的规则
- 信号量机制
  - wait 和 signal
  - 互斥 wait signal 成对出现
  - 同步 wait(empty) signal(full) wait(full) signal(empty)
- 信号量的应用
  - 利用信号量实现进程互斥
  - 利用信号量实现前驱关系
  - 
临界区
进程中访问临界资源的代码：
访问步骤
对要访问的临界资源进行检查
如果此刻没有访问，设置正在访问的标志
访问临界资源
将正在访问的标志回复为被访问的标志

**生产者-消费者问题**